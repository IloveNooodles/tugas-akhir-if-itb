\subsection{Implementasi \textit{Service}}

Implementasi \textit{service} dibuat dengan menggunakan bahasa pemrogramman golang dan framework \textit{Echo} serta menggunakan \textit{REST API} sebagai gaya komunikasinya. Arsitektur kode yang dibuat memiliki tiga lapisan dimulai dari \textit{handler}, \textit{usecase}, dan \textit{repository}. Handler bertujuan membaca permintaan pengguna dan dapat disebut sebagai entrypoint. Data dari handler akan diberikan kepada \textit{usecase} untuk diproses. \textit{Usecase} merupakan lapisan yang hanya memiliki \textit{logic} proses bisnis. Setelah data berhasil melewati lapisan \textit{usecase}, data siap untuk dimasukkan ke database. Proses hubungan antara \textit{service} dengan \textit{database} diletakan pada lapisan \textit{repository}.

Pemisahan lapisan ini mengikuti design pattern yaitu \textit{dependency injection}. Selain itu, pemisahan ini juga bertujuan memudahkan testing dan meningkatkan \textit{maintanability} karena mudah untuk dibaca dan dipahami. \textit{endpoint} dibuat dengan menggunakan versioning dengan base \textit{endpoint} \textbf{/api/v1}. Versioning digunakan untuk memudahkan penggantian endpoint jika suatu saat terdapat perubahan major yang bersifat \textit{breaking}.

Pada sistem ini terdapat \textit{middleware} yang digunakan untuk melakukan autorisasi \textit{pengguna}. Berikut merupakan daftar dan penjelasan \textit{middleware} pada sistem

\begin{enumerate}
  \item ValidateAPIKey

        \textit{Middleware} ini bertujuan untuk memastikan bahwa hanya \textit{client} yang sesuai lah yang dapat mengakses \textit{service}. API Key dikirimkan dengan cara meletakan pada header dengan key \textbf{X-API-Key}. Middleware ini akan dijalankan untuk seluruh \textit{endpoint} yang ada pada \textit{service}.

  \item ValidateJWTKey

        \textit{Middleware} ini memiliki fungsi untuk memvalidasi JWT ketika \textit{user} mengirimkan \textit{request}. \textit{Middleware} ini dijalankan dengan melakukan parsing \textit{accessToken} yang didapat dari cookie pada setiap \textit{request}. Cookie didapat ketika \textit{user} telah melakukan login sebelumnya dan memiliki batas waktu \textit{expire}. Setelah berhasil \textit{login} \textit{user} akan memiliki dua buah cookie yaitu \textit{accessToken} dan \textit{refreshToken}.  \textit{Middleware} ini berjalan untuk seluruh \textit{endpoint user} kecuali \textit{refresh dan login}


  \item ValidateAdminAPIKey

        \textit{middleware} ini memiliki fungsi untuk melakukan autorisasi \textit{admin}. Terdapat Admin API Key yang dilietakan pada header dari setiap \textit{request} dengan key \textbf{X-Admin-API-Key}. Middleware ini berjalan untuk seluruh \textit{endpoint} dengan prefix \textbf{admin-api}.
\end{enumerate}



\subsubsection{Domain \textit{company}}

Domain ini memiliki 4 \textit{endpoint} dengan deskripsi 1 untuk \textit{user} dan 3 untuk \textit{admin}. \textit{middleware} ValidateJWTKey digunakan pada \textit{endpoint user}. Untuk ketiga \textit{endpoint} admin, menggunakan \textit{middleware} ValidateAdminAPIKey. Implementasi dari domain ini akan dijelaskan untuk setiap fungsi dengan acuan gambar \ref{fig:company-class-diagram}


\bgroup
\begin{table}[ht]
  \caption{Api Contract Domain Company}
  \label{tab:api-contract-domain-company}
  \def\arraystretch{1.7}
  \centering
  \begin{tabular}{|c|p{6cm}|p{4cm}|}
    \hline
    Method & Endpoint                    &
    Fungsi                                                  \\
    \hline
    GET    & /api/v1/companies           & GetCompanyDetail \\
    \hline
    POST   & /admin-api/v1/companies     & Create           \\
    \hline
    GET    & /admin-api/v1/companies     & GetAll           \\
    \hline
    GET    & /admin-api/v1/companies/:id & GetById          \\
    \hline
    DELETE & /admin-api/v1/companies/:id & Delete           \\
    \hline
  \end{tabular}
\end{table}
\egroup

\begin{enumerate}
  \item Create

        Fungsionalitas ini menerima masukan berupa json yang dengan \textit{field} \textit{name} dan \textit{cluster\textunderscore name} dari \textit{requester}. Kedua \textit{field} tersebut digunakan untuk mengidentifikasi cluster dari setiap \textit{company}. Terdapat validasi berupa unique(name, cluster\textunderscore name) pada \textit{databse} untuk memastikan bahwa tidak ada duplikat untuk setiap \textit{company}. Setelah semua validasi selesai \textit{server} akan memberikan \textit{response} berupa objek \textit{company} kepada \textit{requester}. Apabila gagal maka akan diberikan pesan error

  \item GetAll

        Fungsionalitas ini dapat dipanggil tanpa masukan apapun oleh admin. Fungsionalitas ini akan mengembalikan semua \textit{company} yang ada pada \textit{database} lalu mengembalikan kepada \textit{requester}.

  \item GetById

        Fungsionalitas ini dapat diakses oleh admin dengan cara memberikan \textit{company id} pada URL. Fungsi ini akan mencari id yang bersesuaian pada \textit{database} lalu mengembalikannya kepada \textit{requester}. Apabila id yang diberikan tidak valid maka akan dikembalikan pesan error

  \item GetCompanyDetail

        Fungsionalitas ini dapat diakses oleh \textit{user} untuk mendapatkan informasi mengenai \textit{company detail} miliknya. Fungsionalitas ini tidak menerima request apapun namun terdapat validasi jika \textit{companyId} dari \textit{user} tidak valid maka akan diberikan pesan error serta apabila \textit{accessToken} sudah \textit{expire} akan dikeluarkan pesan \textit{unauthorized}

  \item Delete

        Fungsionalitas ini dapat diakses oleh \textit{admin} untuk menghapus \textit{company} dari \textit{database}. Karena \textit{company} memiliki relasi ke banyak domain, ketika \textit{company} di delete akan mengadaptasi sistem \textit{cascade} sehingga seluruh data yang memiliki referensi ke \textit{companyId} akan terhapus secara otomatis.

\end{enumerate}



\subsubsection{Domain \textit{user}}
\subsubsection{Domain \textit{devices}}
\subsubsection{Domain \textit{groups}}
\subsubsection{Domain \textit{deployment}}
\subsubsection{Domain \textit{external services}}